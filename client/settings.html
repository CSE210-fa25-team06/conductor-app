<div class="settings-container">
    <header class="settings-header">
        <div style="display:flex; align-items:center; gap: 10px;">
            <h1>Admin CP</h1>
            <button id="btn-admin-help" class="help-icon-btn" title="Admin Guide" type="button">
                <span class="icon">?</span>
            </button>
        </div>
        <div class="settings-subtitle" style="display: flex; gap: 10px; align-items: center;"></div>
    </header>

    <div id="admin-content-wrapper">
        <div class="settings-controls">
            <div class="search-box">
                <input type="text" id="user-search" placeholder="Search" />
            </div>
            <div class="filter-box">
                <label for="role-filter">Filter by role:</label>
                <select id="role-filter">
                    <option value="">All Roles</option>
                </select>
            </div>
        </div>

        <div class="users-table-container">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Group</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body"></tbody>
            </table>
        </div>

        <div id="loading-indicator" class="loading-indicator hidden">
            <p>Loading data...</p>
        </div>
    </div>
</div>

<div id="role-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Assign Roles</h2>
            <button class="modal-close" data-target="role-modal" type="button">&times;</button>
        </div>
        <div class="modal-body">
            <p>Assign roles for: <strong id="modal-user-name"></strong></p>
            <div id="role-checkbox-container"></div>
        </div>
        <div class="modal-footer">
            <button class="button button-secondary" data-target="role-modal" type="button">Cancel</button>
            <button class="button button-primary" id="modal-assign" type="button">Save Roles</button>
        </div>
    </div>
</div>

<div id="group-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Assign Group</h2>
            <button class="modal-close" data-target="group-modal" type="button">&times;</button>
        </div>
        <div class="modal-body">
            <p>Assign group for: <strong id="group-user-name"></strong></p>
            <div class="form-group">
                <label for="group-select">Select Group:</label>
                <select id="group-select" class="role-select"></select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="button button-secondary" data-target="group-modal" type="button">Cancel</button>
            <button class="button button-primary" id="group-save" type="button">Save Group</button>
        </div>
    </div>
</div>

<div id="permissions-modal" class="modal-overlay hidden">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Configure Role</h3>
            <button class="modal-close" data-target="permissions-modal" type="button">&times;</button>
        </div>
        <div class="modal-body flex-body">
            <div class="controls-row" style="display: flex; gap: 2rem; align-items: flex-end;">
                <div style="flex: 1;">
                    <label for="perm-role-select">Select Role:</label>
                    <select id="perm-role-select" style="width: 100%; padding: 8px;"></select>
                </div>
                <div style="width: 150px;">
                    <label for="perm-role-level">Privilege (0-100):</label>
                    <input type="number" id="perm-role-level" min="0" max="100" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>
            <div class="permissions-table-container">
                <table class="permissions-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Current Role</th>
                            <th>Group</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body"></tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button class="button button-secondary" data-target="permissions-modal" type="button">Cancel</button>
            <button class="button button-primary" id="perm-save" disabled type="button">Save Changes</button>
        </div>
    </div>
</div>

<div id="create-group-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Group</h2>
            <button class="modal-close" data-target="create-group-modal" type="button">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="new-group-name">Group Name*</label>
                <input type="text" id="new-group-name" placeholder="e.g. Team Omega">
            </div>
        </div>
        <div class="modal-footer">
            <button class="button button-secondary" data-target="create-group-modal" type="button">Cancel</button>
            <button class="button button-primary" id="create-group-save" type="button">Create Group</button>
        </div>
    </div>
</div>

<div id="create-role-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Role</h2>
            <button class="modal-close" data-target="create-role-modal" type="button">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="new-role-name">Role Name*</label>
                <input type="text" id="new-role-name" placeholder="e.g. Auditor">
            </div>
            <div class="form-group">
                <label for="new-role-desc">Description</label>
                <input type="text" id="new-role-desc" placeholder="e.g. Can view audits but not edit.">
            </div>
            <div class="form-group">
                <label for="new-role-level">Privilege Level (0-100)*</label>
                <input type="number" id="new-role-level" min="0" max="100" step="1">
                <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                    0 = Guest, 1 = Student, 100 = Professor
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="button button-secondary" data-target="create-role-modal" type="button">Cancel</button>
            <button class="button button-primary" id="create-role-save" type="button">Create Role</button>
        </div>
    </div>
</div>

<div id="defaults-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>System Defaults</h2>
            <button class="modal-close" data-target="defaults-modal" type="button">&times;</button>
        </div>
        <div class="modal-body">
            <p>Select the default assignments for new users when they first sign up.</p>
            <div class="form-group">
                <label for="default-role-select">Default Role:</label>
                <select id="default-role-select" class="role-select"></select>
                <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                    Users will automatically receive this role upon registration.
                </p>
            </div>
            <div class="form-group" style="margin-top: 1.5rem;">
                <label for="default-group-select">Default Group:</label>
                <select id="default-group-select" class="role-select"></select>
                <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                    Users will be placed in this group (usually "Unassigned").
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="button button-secondary" data-target="defaults-modal" type="button">Cancel</button>
            <button class="button button-primary" id="save-defaults-btn" type="button">Save Defaults</button>
        </div>
    </div>
</div>

<div id="import-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Import Users</h2>
            <button class="modal-close" data-target="import-modal" type="button">&times;</button>
        </div>
        <div class="modal-body">
            <p>Upload a CSV file to provision multiple users at once.</p>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 1.5rem; font-size: 0.9rem; color: #555;">
                <strong>Required CSV Columns:</strong><br>
                <code style="display:block; margin-top:5px; padding:5px; background:#eee; border-radius:4px;">email, name, role, group</code>
            </div>
            <div class="form-group">
                <label for="csv-file-input">Select CSV File:</label>
                <input type="file" id="csv-file-input" accept=".csv" style="padding: 10px; border: 1px dashed #ccc;">
            </div>
        </div>
        <div class="modal-footer">
            <button class="button button-secondary" data-target="import-modal" type="button">Cancel</button>
            <button class="button button-primary" id="btn-process-import" type="button">Create Users</button>
        </div>
    </div>
</div>

<div id="help-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Admin Feature Guide</h2>
            <button class="modal-close" data-target="help-modal" type="button">&times;</button>
        </div>
        <div class="modal-body">
            <div class="help-section">
                <h3>Privilege Levels (0-100)</h3>
                <p>The Privilege Level establishes a strict role hierarchy. Lower numbers indicate fewer administrative responsibilities.</p>
                <ul class="help-list">
                    <li><strong>Unprivileged role (level &le; 1):</strong> Guests, Students, Group Leaders. These are standard users and can be set as defaults.</li>
                    <li><strong>Privileged role (level &gt; 1):</strong> Tutors, TAs, Professors. These roles have administrative powers and <span style="color: #c62828;">cannot</span> be set as defaults.</li>
                </ul>
            </div>

            <div class="help-section" style="margin-top: 1.5rem;">
                <h3>Security Rules</h3>

                <div style="background: #fff3cd; color: #856404; padding: 10px; border-left: 4px solid #ffeeba; margin: 10px 0; font-size: 0.9rem;">
                    <strong>Permissions Inheritance Rule:</strong> If a user has multiple roles with the same privilege level, the user has the permissions of every role assigned.
                </div>
                <div style="background: #fff3cd; color: #856404; padding: 10px; border-left: 4px solid #ffeeba; margin: 10px 0; font-size: 0.9rem;">
                    <strong>Security Rule:</strong> If a user has roles with different privilege levels, the system <ins>only</ins> honors the roles with <strong>lowest</strong> privilege levels.
                </div>
            </div>

            <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid #eee;">

            <div class="help-section">
                <h3>Configuring Role Permissions</h3>
                <p>You can redefine what each role is allowed to do using the <strong>Manage Role Permissions</strong> tool.</p>
                <ul class="help-list">
                    <li><strong>View permissions:</strong> Select a role to see a checklist of every permission assigned to that role.</li>
                    <li><strong>Toggle permissions:</strong> Check or uncheck boxes to grant or revoke specific permissions (such as <code>VIEW_CLASS_DIRECTORY</code> or <code>USER_SUBMIT_JOURNAL</code>).</li>
                    <li><strong>Save changes:</strong> Saved changes apply immediately to <strong>every user</strong> who holds that role.</li>
                </ul>
            </div>
        </div>
        <div class="modal-footer">
            <button class="button button-primary" data-target="help-modal" type="button">Got it</button>
        </div>
    </div>
</div>

<div id="toast-container"></div>